# 流水线CPU设计文档
分布式译码
 + 方便之处：每一级只传入这一级需要的控制信号（controller, 流水线寄存器）
 + 缺点：需要多次实例化Controller
控制器采用指令驱动型
1. 如果我把NPC作为计算PC地址的唯一来源，即PC一行的所有数据全由NPC计算出来，然后导入到PC中，会有什么问题吗
 + PC 必須「等待」整整一個週期，等當前指令流過 ID 級，NPC 才能給出答案。
为何不传PC+4
 + 因为PC值要始终传输，不如每一次需要时计算PC+4/8
## 命名规范
- 模块名：级别_模块名，如 F_PC, D_GRF
- 端口名：级别_端口名，如 F_PC_en, D_A1，一些特殊端口可省略级别前缀，如 clk, reset
- 寄存器名：两个级别_寄存器名，如 FD_Instr,
- 主文件中的临时wire信号：小写级别_信号名

## CONTROLLER (主控制器)
- **功能**: 根据指令的 opcode 和 funct 生成各级所需的控制信号。


| 端口名     | 位宽 | 方向 | 功能说明                                                     |
| ---------- | ---- | ---- | ------------------------------------------------------------ |
| opcode     | 6    | I    | 指令操作码                                                   |
| funct      | 6    | I    | R 型指令功能码                                               |
| RFWr    | 1    | O    |  寄存器写使能 (传递用)           |
| DMWr    | 1    | O    |  内存写使能 (传递用)              |
| ALUOp  | 3   | O    |  ALU 运算类型 (传递用)          |
| ExtOp   | 1    | O    | 立即数扩展方式 (传递用)        |
| CmpOp   | 3    | O    | 比较操作类型 D级比较信号用于跳转(取代Zero)   |
| Reg_WrSrc | 2    | O    |  寄存器写数据源选择 (传递用)       |
| ALU_BSrc  | 2    | O    |  ALU 第二操作数选择  |
| Reg_WrSel | 2    | O    |  写入寄存器地址选择         |    
| T\_new\_D  | 2    | O    |  "生产时间" 初始值 (送往冒险控制器)  |
| T\_use\_RS | 2    | O    |  "RS 消费时间" (送往冒险控制器)    |
| T\_use\_RT | 2    | O    |  "RT 消费时间" (送往冒险控制器)    |                      |

## F级：IF (取指令) 阶段

本阶段负责获取当前指令。

### F_PC (Program Counter)
- **功能**: 保存当前指令地址。在流水线中，它需要接收下一地址（来自NPC MUX）。

| 端口名 | 位宽 | 方向 | 功能说明 |
| :--- | :--- | :--- | :--- |
| clk | 1 | I | 时钟信号 |
| reset | 1 | I | 同步复位信号 |
| F_PC_en | 1 | I | PC写使能（来自冒险控制器，用于暂停） |
| NPC_in | 32 | I | 下一条指令地址（来自NPC MUX的最终选择） |
| F_PC | 32 | O | 当前PC地址（送往 IM 和 NPC） |

### F_IM (Instruction Memory)
- **功能**: 根据 PC 输出的地址，（组合逻辑）读出指令。

| 端口名 | 位宽 | 方向 | 功能说明 |
| :--- | :--- | :--- | :--- |
| A | 32 | I | 指令地址输入 (来自 `PC_out`)|
| F_Instr | 32 | O | 32位机器指令内容 (送往 `IF/ID` 寄存器) |


## FD_REG（D级流水线寄存器）
**暂停时本级无需清0，只需要使能信号为0即可保持原值。**
| 端口名 | 位宽 | 方向 | 功能说明 |
|--------|------|------|----------|
| clk    | 1    | I    | 时钟信号 |
| reset  | 1    | I    | 同步复位信号 |
| FD_en  | 1    | I    | 寄存器使能（0=保持/暂停，1=正常更新） |
| **（来自 F 级的输入）** |      |      |          |
| F_Instr | 32 | I  | 来自指令存储器（IM）的 32 位指令 |
| F_PC   | 32 | I  | 来自 IF 级的 PC 值(jal)  |
| **（输出到 D 级的信号）** |      |      |          |
| D_Instr | 32 | O  | 输出到 ID 级的 32 位指令 |
| D_PC   | 32 | O  | 输出到 ID 级的 PC 值  |

**PC值需要一直传递**

## D级：ID (译码/读寄存器) 阶段

本阶段负责译码、读取寄存器堆(RF)以及产生控制信号。

### Splitter (指令译码/拆分)
- **功能**: 将 FD_REG 传来的32位指令拆分为各个字段。
- **注意：该模块有两个实例，一个在D级读取拆分指令，获得rs,rt,rd,i16**
- **另一个在controller里实例，用于生成控制指令，因为实现的是分布式译码**
| 端口名 | 位宽 | 方向 | 功能说明 |
| :--- | :--- | :--- | :--- |
| Instr | 32 | I | 来自 `FD_REG`的指令 |
| opcode | 6 | O | 操作码 (送往相应控制器)  |
| rs | 5 | O | 源寄存器1 (送往 GRF A1) |
| rt | 5 | O | 源寄存器2 (送往 GRF A2 / A3 MUX)  |
| rd | 5 | O | 目的寄存器 (送往 A3 MUX)  |
| funct | 6 | O | 功能码 (送往相应控制器)  |
| i16 | 16 | O | 16位立即数 (送往 EXT) |
| instr_index | 26 | O | 26位跳转立即数 (送往 `D/E`) |


### GRF (通用寄存器组)

| 端口名 | 位宽 | 方向 | 功能说明 |
| :--- | :--- | :--- | :--- |
| clk | 1 | I | 时钟信号 |
| reset | 1 | I | 同步复位 |
| A1 | 5 | I | 读端口 1 地址 (来自 `rs`)  |
| A2 | 5 | I | 读端口 2 地址 (来自 `rt`)  |
| RD1 | 32 | O | 读出的数据 1 (Value 1) |
| RD2 | 32 | O | 读出的数据 2 (Value 2) |
| A3 | 5 | I | **W级** 写入地址 (来自 `W_A3`)  |
| WD | 32 | I | **W级** 写入数据 (来自 WB MUX)|
| RFWr | 1 | I | **W级** 写入使能 (来自 W_Controller `W_RFWr`)|

### EXT (立即数扩展单元)
- **功能**: 将 16 位立即数扩展为 32 位。

| 端口名 | 位宽 | 方向 | 功能说明 |
| :--- | :--- | :--- | :--- |
| D_Imm16 | 16 | I | 16位立即数输入 (来自 Splitter) |
| D_ExtOp | 1 | I | 扩展操作选择 (来自 D_Controller) |
| D_E32 | 32 | O | 32位扩展结果 (Value 32) |

### A3_MUX (目的寄存器地址 MUX)
- **功能**: 根据指令类型（如 `P4` 中的 `RegDst` 信号），选择 `rt` 或 `rd` 或 `$ra(31)` 作为目的寄存器地址 `A3` [cite: 452]。

| 端口名 | 位宽 | 方向 | 功能说明 |
| :--- | :--- | :--- | :--- |
| D_rt | 5 | I | rt 寄存器地址 |
| D_rd | 5 | I | rd 寄存器地址 |
| D_RA31 | 5 | I | 31号寄存器，常数 | 
| D_Reg_WrSel | 2 | I | 目的寄存器选择信号 (来自 D_Controller) |
| D_RegDst | 5 | O | 最终的目的寄存器地址 (**一直往后送**)  |

- **注意：D_RegDst 生成后一直流水线传递到W级。**

### D_CMP (ID級比較器)
+
* **功能**: 在 ID 級執行对**转发过来的数据A1 A2**比較運算（例如 `beq` 的相等比較 ），提前生成分支是否跳轉的信號。

| 端口名 | 位寬 | 方向 | 功能描述 |
| :--- | :--- | :--- | :--- |
| `D_A1` | 32 | I | 來自 `rs` (A1) 的值，**是已處理轉發 (Forwarded) 後的最終值** |
| `D_A2[31:0]` | 32 | I | 來自 `rt` (A2) 的值，**是已處理轉發 (Forwarded) 後的最終值** |
| `CmpOp[2:0]` | 3 | I | 比較操作控制信號（来自 D_Controller） ，例如 `CMP_beq` |
| `D_bjump` | 1 | O | 比較結果 / 分支條件滿足標誌 (1=滿足, 0=不滿足)，此信號將送往 `NPC` 模塊進行下一PC決策 |

**注意：GRF读出的rs/rt值先转发，再连接到CMP和下一级寄存器**

### DF_NPC (Next Program Counter)

功能: 计算下一条指令地址 (PC+4 或分支目标地址)。

| 端口名 | 位宽 | 方向 | 功能说明 |
|---|---|---|---|
| F_PC[31:0] | 32 | I | F级获取的指令地址 |
| D_PC[31:0] | 32 | I | D级获取的流水指令地址，用于跳转PC+8 |
| D_imm26[25:0] | 26 | I | 26位立即数 |
| D_imm16[25:0] | 26 | I | 16位立即数 |
| D_RA[31:0]  | 32 | I | **转发后**$31保存的寄存器地址,**来自A1**|
| nPC_sel[1:0] | 2 | I | 下一 PC 选择信号 |
| `D_bjump` | 1 | I | 分支条件满足标志 (用于 beq 条件判断) |
| NPC[31:0] | 32 | O | 下一条指令地址 |

**注意RA需要先转发（例如汇编中保存寄存器的sp）**

--- 
## DE_REG（ID/EX 流水线寄存器）
### 功能  
锁存 ID 级（译码）的输出，作为 EX 级（执行）的输入。需传递所有数据和控制信号，并**支持「清空」以处理 `lw` 指令的加载延迟槽**。

| 端口名 | 位宽 | 方向 | 功能说明 |
|--------|------|------|----------|
| clk    | 1    | I    | 时钟信号 |
| reset  | 1    | I    | 同步复位信号 |
| DE_clr | 1    | I    | 寄存器清除（1=清零/插入nop，0=正常） |
| **（数据输入）** |      |      |          |
| D_V1   | 32   | I    | 来自 ID 级的 已转发过的RF 读出值 1（V1） |
| D_V2   | 32   | I    | 来自 ID 级的 已转发过的RF 读出值 2（V2） |
| D_E32  | 32   | I    | 来自 ID 级的 32 位立即数扩展结果 |
| **（地址输入）** |      |      |          |
| D_PC   | 32   | I    | 来自 ID 级的 PC 值 |
| D_A3   | 5   | I     | 来自 ID 级产生的写入寄存器地址 | 
| **（指令输入）包含rt,rd,rs地址）** |      |      |          |
| D_Instr | 32 | I | 来自FD_REG上一级的指令 |
| **（控制输入）** |      |      |          |
| **（数据输出）** |      |      |          |
| E_V1   | 32   | O    | 输出到 EX 级的 V1 |
| E_V2   | 32   | O    | 输出到 EX 级的 V2 |
| E_E32  | 32   | O    | 输出到 EX 级的 E32  |
| **（地址输入）** |      |      |          |
| E_PC   | 32   | O    | 输出到 EX 级的 当前指令地址 |
| E_A3   | 5   | O     | 输出到 EX 级的 写入寄存器地址 | 
| **（指令输出）** |      |      |          |
| E_Instr | 32   |   O   | 输出到EX一级的指令 |
| **（控制输出）** |      |      |          |
| E_Tnew   | 2    | O    | **生成** EX 级的 T_new 值 |

1. **注意暂停操作需要把这里清空**
2. **E_T_new在这里根据指令产生值。**
---

## E级：EX (执行) 阶段

本阶段主要负责算术逻辑运算。

### ALU (算术逻辑单元)
- **功能**: 执行运算。输入端需要**转发MUX**来接收来自 EX, MEM, WB 级的数据。

| 端口名 | 位宽 | 方向 | 功能说明 |
| :--- | :--- | :--- | :--- |
| A | 32 | I |   输入操作数 1 (来自**转发 MUX A**) |
| B | 32 | I |   输入操作数 2 (来自**转发 MUX B**) |
| E_ALUOp | 3 | I | 运算控制信号 (来自**E_Controller**) |
| E_AO | 32 | O | 运算结果 (ALU Out)|

### ALU_B_MUX   
- **功能**：选择ALU B输入端的数据: 转发过的V2 或者 E32。
  
| 端口名 | 位宽 | 方向 | 功能说明 |
| :--- | :--- | :--- | :--- |
| E_V2 | 32 | I | E级的第二个值V2(RD2)|
| E_ALU_BSrc | 2 | I | 选择信号| 
| E_ALUB | 32 | O | 输出到ALUB端的数值  |

  
### E_WD_MUX   
- **功能**：E级处，选择正确的寄存器写入值，即为转发出的值
这时，能产生正确写入值的指令只有PC类(jal)【**策略矩阵**】

| 端口名 | 位宽 | 方向 | 功能说明 |
| :--- | :--- | :--- | :--- |
| E_PC | 32 | I | 输入E级的指令当前地址|
| E_Reg_WrSrc| 2 | I | 选择信号（只有jal类信号有值，其他均为0 | 
| E_WD | 32 | O | E级处产生的写入值（只可能是PC+8，其他均为0） (**一直往后送**)  |

---
## EM_REG（EX/MEM 流水线寄存器）

| 端口名 | 位宽 | 方向 | 功能说明 |
|--------|------|------|----------|
| clk    | 1    | I    | 时钟信号 |
| reset  | 1    | I    | 同步复位信号 |
| **（指令输入）** |      |      |          |
| E_Instr | 32   |   O   | 来自EX一级的指令 |
| **（数据输入）** |      |      |          |
| E_AO    | 32   | I    | 来自 EX 级的 ALU 运算结果  |
| E_V2    | 32   | I    | 来自 EX 级的 V2 值（用于 sw 写入 DM） |
| E_PC    | 32   | I    | 来自 EX 级的 当前指令地址 |
| **（地址输入）** |      |      |          |
| E_A3    | 5    | I    | 来自 EX 级的 A3（目的寄存器）地址  |
| **（控制输入）** |      |      |          |
| E_Tnew    | 2    | I    | 来自 EX 级的 T_new 值 |
| **（指令输出）** |      |      |          |
| M_Instr | 32   |   O   | 输出到 MWM 级的指令 |
| **（数据输出）** |      |      |          |
| M_AO    | 32   | O    | 输出到 MEM 级的 ALU 结果 |
| M_V2    | 32   | O    | 输出到 MEM 级的 V2 值 |
| M_PC    | 32   | O    | 输出到 MEM 级的 当前指令地址（用于 jal 回写）  |
| **（地址输出）** |      |      |          |
| M_A3    | 5    | O    | 输出到 MEM 级的 A3 地址 |
| **（控制输出）** |      |      |          |
| M_RFWr   | 1    | O    | 输出到 MEM 级的 RFWr 信号  |
| M_DMWr    | 1    | O    | 输出到 MEM 级的 DMWr 信号 |
| M_Tnew    | 2    | O    | 输出到 MEM 级的 T_new 值 **需要减一** |

1. **记得Tnew -1**
   
---

## M级：MEM (访存) 阶段

本阶段负责与数据存储器交互。

### DM (数据存储器)
- **功能**: 根据 `lw/sw` 指令进行数据读写。

| 端口名 | 位宽 | 方向 | 功能说明 |
| :--- | :--- | :--- | :--- |
| clk | 1 | I | 时钟信号 |
| reset | 1 | I | 同步复位 |
| A | 32 | I |   读/写地址 (来自 `EX/MEM.M_AO`) |
| M_WD | 32 | I |   写入数据 (来自 `EX/MEM.M_V2`) |
| DMWr | 1 | I |   写使能信号 (来自 M_Controller)  |
| RD | 32 | O |   读出数据  (送往 `MEM/WB`) |

### M_WD_MUX   
- **功能**：M级处，选择正确的寄存器写入值，即为可能转发出的值
这时，能产生正确写入值的指令有PC类(jal)和ALU类【**策略矩阵**】

| 端口名 | 位宽 | 方向 | 功能说明 |
| :--- | :--- | :--- | :--- |
| M_PC | 32 | I | 输入E级的指令当前地址|
| M_AO | 32 | I | 上一级计算的ALU结果 |    
| E_Reg_WrSrc| 2 | I | 选择信号 | 
| E_WD | 32 | O | E级处产生的写入值（**只可能是PC+8或ALU结果，其他为0**）  |

---
## MW_REG（MEM/WB 流水线寄存器）

流水线最后一级锁存。

| 端口名 | 位宽 | 方向 | 功能说明 |
|--------|------|------|----------|
| clk    | 1    | I    | 时钟信号 |
| reset  | 1    | I    | 同步复位信号 |
| **（指令输入）** |      |      |          |
| M_Instr | 32   |   O   | 来自 MEM 级的指令 |
| **（数据输入）** |      |      |          |
| M_AO    | 32   | I    | 来自 MEM 级的 ALU 结果 |
| M_RD    | 32   | I    | 来自 MEM 级的 DM 读出数据  |
| M_PC    | 32   | I    | 来自 MEM 级的 PC 值 |
| **（地址输入）** |      |      |          |
| M_A3    | 5    | I    | 来自 MEM 级的 A3（目的寄存器）地址 |
| **（指令输出）** |      |      |          |
| W_Instr | 32   |   O   | 输出到 WB 级的指令 |
| **（数据输出）** |      |      |          |
| W_AO    | 32   | O    | 输出到 WB 级的 ALU 结果  |
| W_RD    | 32   | O    | 输出到 WB 级的 DM 读出数据  |
| W_PC    | 32   | O    | 输出到 WB 级的 PC 值|
| **（地址输出）** |      |      |          |
| W_A3    | 5    | O    | 输出到 WB 级的 A3 地址 |


1. Tnew一定减为0了
   
---
## W级：WB (回写) 阶段

本阶段负责将最终结果写回寄存器堆(GRF)。

### WB_MUX (回写 MUX)
-   **功能**: 选择写回 GRF 的数据来源：是来自 ALU 的结果 (`M_AO`) 还是来自 DM 的结果 (`M_RD`)  还是 PC+8 (`M_PC`)(jal)

| 端口名 | 位宽 | 方向 | 功能说明 |
| :--- | :--- | :--- | :--- |
| AO_W | 32 | I | 来自 `MEM/WB` 的 ALU 结果 |
| DR_W | 32 | I | 来自 `MEM/WB` 的内存读出数据 |
| M_PC | 32 | I | 当前指令值 | 
| Reg_WrSel | 2 | I | 写回数据源选择信号 (来自 `MEM/WB`) |
| W_WD | 32 | O |   最终写回 RF 的数据  |

---

## 流水线专用部件

这些是实现流水线所**必须新增**的模块。

### Hazard_Controller (冒险控制器)
-   **功能**: 核心模块。根据**生产-消费模型**   和**策略矩阵** 生成暂停和转发信号。

| 端口名 | 位宽 | 方向 | 功能说明 |
| :--- | :--- | :--- | :--- |
| D_T_use_RS, D_T_use_RT | 2 | I |   D级指令的 "消费时间" |
| E_Tnew, M_Tnew | 2 | I |   E级和M级指令的 "生产时间" |
| D_A1, D_A2 | 5 | I | D级读取的寄存器地址 |
| E_A3, M_A3| 5 | I |   E, M级的目的寄存器地址  |
| E_RFWr, M_RFWr| 1 | I |   E, M级的写使能信号 |
| Stall | 1 | O |   暂停信号 (送往 PC 和 IF/ID 寄存器)  |
| E_Fwd_A_Sel | 2 | O |   ALU A端转发MUX控制信号 |
| E_Fwd_B_Sel | 2 | O |   ALU B端转发MUX控制信号 |

### Forwarding_MUXes (转发 MUX)
-   **功能**: 位于 EX 级 ALU 的输入端，根据冒险控制器的信号，选择正确的数据来源。
-   **例如：MFALUBE (ALU B端转发MUX)** 
-   D级的RF后 rs、rt各需要一个转发
-   E级的ALU A B端各需要一个转发
-   M级 DM处的WD输入需要一个转发

| 端口名 | 位宽 | 方向 | 功能说明 |
| :--- | :--- | :--- | :--- |
| V2_E | 32 | I |   来源0：ID/EX 寄存器的 V2 值 (默认) [cite: 458] |
| DR_W | 32 | I |   来源1：MEM/WB 的 DM 读出值 [cite: 458] |
| AO_W | 32 | I |   来源2：MEM/WB 的 ALU 结果 [cite: 458] |
| AO_M | 32 | I |   来源3：EX/MEM 的 ALU 结果 (最高优先级) [cite: 458] |
| Fwd_B_Sel | 2 | I | 选择信号 (来自 Hazard Controller) |
| ALU_B | 32 | O |   最终送往 ALU B端的数据 [cite: 457] |





## 思考题