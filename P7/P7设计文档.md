# 流水线CPU设计文档


## 设计思路
- 分布式译码- 
- 控制器采用指令驱动型
  - 劣势：判断非法指令需要再次判断
## 命名规范
- 模块名：级别_模块名，如 F_PC, D_GRF
- 端口名：级别_端口名，如 F_PC_en, D_A1，一些特殊端口可省略级别前缀，如 clk, reset
- 寄存器名：两个级别_寄存器名，如 FD_Instr,
- 主文件中的临时wire信号：小写级别_信号名
- 功能部件 MUX 用 always 实现，转发 MUX 用 assign 语句实现。

## 支持指令集
add, sub, and, or, slt, sltu, lui
addi, andi, ori
lb, lh, lw, sb, sh, sw
mult, multu, div, divu, mfhi, mflo, mthi, mtlo
beq, bne, jal, jr
mfc0, mtc0, eret, syscall

普通计算类指令：add, sub, **and, or, slt, sltu**, lui, **addi, andi,** ori
乘除槽：**mult, div, divu, mfhi, mflo, mthi, mtlo**
访存类指令：**lb, lh**, lw, **sb, sh,** sw
跳转类指令：beq, **bne**, jal, jr


## Mips （顶层模块） 

顶层模块 `mips` 是整个微系统的入口，负责将内部 CPU 核心与外部存储器（IM/DM）及外设中断发生器进行交互。

| 端口名 | 位宽 | 方向 | 功能说明 |
| --- | --- | --- | --- |
| **clk** | 1 | I | 时钟信号 |
| **reset** | 1 | I | 同步复位信号 |
| **interrupt** | 1 | I | **[P7新增]** 外部中断信号。由中断发生器产生，需送往 CP0 |
| **macroscopic_pc** | 32 | O | **[P7新增]** 宏观 PC。用于定位当前生效的指令（通常取 M 级 PC） |
| **i_inst_addr** | 32 | O | IM 读取地址（取指阶段的 PC） |
| **i_inst_rdata** | 32 | I | IM 读取的指令数据 |
| **m_data_addr** | 32 | O | DM/外设 读写地址 |
| **m_data_rdata** | 32 | I | DM/外设 读取的数据 |
| **m_data_wdata** | 32 | O | DM/外设 待写入数据 |
| **m_data_byteen** | 4 | O | DM/外设 字节使能信号（支持 `sb`, `sh`, `sw`） |
| **m_int_addr** | 32 | O | **[P7新增]** 中断发生器待写入地址。用于响应外部中断 |
| **m_int_byteen** | 4 | O | **[P7新增]** 中断发生器字节使能信号。任意一位置位视为响应 |
| **m_inst_addr** | 32 | O | M 级 PC 值（用于评测与调试） |
| **w_grf_we** | 1 | O | GRF 写使能信号（用于评测） |
| **w_grf_addr** | 5 | O | GRF 待写入寄存器编号 |
| **w_grf_wdata** | 32 | O | GRF 待写入数据 |
| **w_inst_addr** | 32 | O | W 级 PC 值（用于评测与调试） |


## CP0(协处理器0)

- **功能**: 处理异常和中断，管理系统状态寄存器。
- **系统状态寄存器**
- SR寄存器：
- Cause寄存器：
- EPC 寄存器：保存陷入内核指令的**上一条指令**地址。（例如重新判断跳转指令）
- PRId寄存器：处理器标识寄存器，固定值。

---

## CP0 (协处理器 0)

* **功能**: CP0 是 MIPS 处理器的异常处理中心，负责缓存异常信息（`Cause`）、控制中断使能（`SR`）、保存返回地址（`EPC`）以及提供处理器标识（`PRId`）。

### CP0 模块接口

| 端口名 | 位宽 | 方向 | 功能说明 |
| --- | --- | --- | --- |
| `clk` | 1 | I | 时钟信号 |
| `rst` | 1 | I | 同步复位信号 |
| `A1` | 5 | I | 读寄存器编号（来自 `mfc0` 指令的 `rd` 字段） |
| `A2` | 5 | I | 写寄存器编号（来自 `mtc0` 指令的 `rd` 字段） |
| `DIn` | 32 | I | 待写入 CP0 的数据（来自 GRF 的 `rt` 值） |
| `PC` | 32 | I | 发生异常/中断时的 PC 值 |
| `ExcCode` | 5 | I | 异常码（标识当前的异常或中断类型） |
| `HWInt` | 6 | I | 6 个外部硬件中断输入（来自 Bridge/Timer） |
| `CPWr` | 1 | I | 写使能信号（执行 `mtc0` 指令时产生） |
| `EXLSet` | 1 | I | 置位 `SR.EXL`（当异常或中断请求生效时产生） |
| `EXLClr` | 1 | I | 清除 `SR.EXL`（执行 `eret` 指令时产生） |
| `IntReq` | 1 | O | **中断请求信号**（送往流水线控制器，用于触发跳转） |
| `EPC` | 32 | O | EPC 寄存器输出值 |
| `DOut` | 32 | O | CP0 寄存器读出数据（送往回写通路） |

### 异常支持表
| ExcCode | 助记符 | 描述 |
| --- | --- | --- |
| **0** | **Int** | **外部中断**。来自外部设备。 |
| **4** | **AdEL** | **取数或取指时地址错误**。通常是地址不对齐或越界。 |
| **5** | **AdES** | **存数时地址错误**。通常是地址不对齐或试图写只读区域。 |
| **8** | **Syscall** | **系统调用**。由 `syscall` 指令主动触发。 |
| **10** | **RI** | **非法指令码**。译码阶段无法识别的指令。 |
| **12** | **Ov** | **算术溢出**。自陷形式的整数运算指令（如 `add`, `addi`, `sub`）导致。 |



### 内部关键寄存器定义

| 寄存器 | 编号 | 位域说明 |
| --- | --- | --- |
| **SR (Status)** | 12 | `IM[15:8]`: 中断屏蔽位；`EXL[1]`: 异常级标志；`IE[0]`: 全局中断使能 |
| **Cause** | 13 | `BD[31]`: 延迟槽标志；`IP[15:10]`: 待处理中断；`ExcCode[6:2]`: 异常编码 |
| **EPC** | 14 | 记录异常处理后的返回地址。若在延迟槽中，指向当前 PC-4 |
| **PRId** | 15 | 处理器标识符（ReadOnly），写死为自定义彩蛋（如：`0x20251218`） |


## CONTROLLER (主控制器)
- **功能**: 根据指令的 opcode 和 funct 生成各级所需的控制信号。


| 端口名     | 位宽 | 方向 | 功能说明                                                     |
| ---------- | ---- | ---- | ------------------------------------------------------------ |
| opcode     | 6    | I    | 指令操作码                                                   |
| funct      | 6    | I    | R 型指令功能码                                               |
| RFWr    | 1    | O    |  寄存器写使能 (传递用)           |
| DMWr    | 1    | O    |  内存写使能 (传递用)              |
| ALUOp  | 3   | O    |  ALU 运算类型 (传递用)          |
| ExtOp   | 1    | O    | 立即数扩展方式 (传递用)        |
| CmpOp   | 3    | O    | 比较操作类型 D级比较信号用于跳转(取代Zero)   |
| Reg_WrSrc | 2    | O    |  寄存器写数据源选择 (传递用)       |
| ALU_BSrc  | 2    | O    |  ALU 第二操作数选择  |
| Reg_WrSel | 2    | O    |  写入寄存器地址选择         |
| T\_use\_RS | 2    | O    |  "RS 消费时间" (送往冒险控制器)    |
| T\_use\_RT | 2    | O    |  "RT 消费时间" (送往冒险控制器)    |

**每一级Controller生成的所需信息不同**
- D级：EXTOp，Reg_WrSrc
- E级：ALU_BSrc, Reg_WrSrc
## F级：IF (取指令) 阶段

本阶段负责获取当前指令。

### F_PC (Program Counter)
- **功能**: 保存当前指令地址。在流水线中，它需要接收下一地址（来自NPC MUX）。

| 端口名 | 位宽 | 方向 | 功能说明 |
| :--- | :--- | :--- | :--- |
| clk | 1 | I | 时钟信号 |
| reset | 1 | I | 同步复位信号 |
| F_PC_en | 1 | I | PC写使能（来自冒险控制器，用于暂停）1为可以写入 |
| F_NPC_in | 32 | I | 下一条指令地址（来自NPC MUX的最终选择） |
| F_PC | 32 | O | 当前PC地址（送往 IM 和 NPC） |



## FD_REG（D级流水线寄存器）
**暂停时本级无需清0，只需要使能信号为0即可保持原值。**
| 端口名 | 位宽 | 方向 | 功能说明 |
|--------|------|------|----------|
| clk    | 1    | I    | 时钟信号 |
| reset  | 1    | I    | 同步复位信号 |
| FD_en  | 1    | I    | 寄存器使能（0=保持/暂停，1=正常更新） |
| **（来自 F 级的输入）** |      |      |          |
| F_Instr | 32 | I  | 来自指令存储器（IM）的 32 位指令 |
| F_PC   | 32 | I  | 来自 IF 级的 PC 值(jal)  |
| **（输出到 D 级的信号）** |      |      |          |
| D_Instr | 32 | O  | 输出到 ID 级的 32 位指令 |
| D_PC   | 32 | O  | 输出到 ID 级的 PC 值  |

**PC值需要一直传递**

## D级：ID (译码/读寄存器) 阶段

本阶段负责译码、读取寄存器堆(RF)以及产生控制信号。

### Splitter (指令译码/拆分)
- **功能**: 将 FD_REG 传来的32位指令拆分为各个字段。
- **注意：该模块有两个实例，一个在D级读取拆分指令，获得rs,rt,rd,i16**
- **另一个在controller里实例，用于生成控制指令，因为实现的是分布式译码**
| 端口名 | 位宽 | 方向 | 功能说明 |
| :--- | :--- | :--- | :--- |
| Instr | 32 | I | 来自 `FD_REG`的指令 |
| opcode | 6 | O | 操作码 (送往相应控制器)  |
| rs | 5 | O | 源寄存器1 (送往 GRF A1) |
| rt | 5 | O | 源寄存器2 (送往 GRF A2 / A3 MUX)  |
| rd | 5 | O | 目的寄存器 (送往 A3 MUX)  |
| funct | 6 | O | 功能码 (送往相应控制器)  |
| i16 | 16 | O | 16位立即数 (送往 EXT) |
| i26 | 26 | O | 26位跳转立即数 (送往 `NPC`) |


### GRF (通用寄存器组)

| 端口名 | 位宽 | 方向 | 功能说明 |
| :--- | :--- | :--- | :--- |
| clk | 1 | I | 时钟信号 |
| reset | 1 | I | 同步复位 |
| A1 | 5 | I | 读端口 1 地址 (来自 `rs`)  |
| A2 | 5 | I | 读端口 2 地址 (来自 `rt`)  |
| RD1 | 32 | O | 读出的数据 1 (Value 1) |
| RD2 | 32 | O | 读出的数据 2 (Value 2) |
| A3 | 5 | I | **W级** 写入地址 (来自 `W_A3`)  |
| WD | 32 | I | **W级** 写入数据 (来自 WB MUX)|
| RFWr | 1 | I | **W级** 写入使能 (来自 W_Controller `W_RFWr`)|

### EXT (立即数扩展单元)
- **功能**: 将 16 位立即数扩展为 32 位。

| 端口名 | 位宽 | 方向 | 功能说明 |
| :--- | :--- | :--- | :--- |
| D_Imm16 | 16 | I | 16位立即数输入 (来自 Splitter) |
| D_ExtOp | 1 | I | 扩展操作选择 (来自 D_Controller) |
| D_E32 | 32 | O | 32位扩展结果 (Value 32) |

### A3_MUX (目的寄存器地址 MUX)
- **功能**: 根据指令类型（如 `P4` 中的 `RegDst` 信号），选择 `rt` 或 `rd` 或 `$ra(31)` 作为目的寄存器地址 `A3` [cite: 452]。

| 端口名 | 位宽 | 方向 | 功能说明 |
| :--- | :--- | :--- | :--- |
| D_rt | 5 | I | rt 寄存器地址 |
| D_rd | 5 | I | rd 寄存器地址 |
| D_RA31 | 5 | I | 31号寄存器，常数 | 
| D_Reg_WrSel | 2 | I | 目的寄存器选择信号 (来自 D_Controller) |
| D_RegDst | 5 | O | 最终的目的寄存器地址 (**一直往后送**)  |

- **注意：D_RegDst 生成后一直流水线传递到W级。**

### D_CMP (ID級比較器)
* **功能**: 在 ID 級執行对**转发过来的数据A1 A2**比較運算（例如 `beq` 的相等比較 ），提前生成分支是否跳轉的信號。

| 端口名 | 位寬 | 方向 | 功能描述 |
| :--- | :--- | :--- | :--- |
| `D_A1` | 32 | I | 來自 `rs` (A1) 的值，**是已處理轉發 (Forwarded) 後的最終值** |
| `D_A2[31:0]` | 32 | I | 來自 `rt` (A2) 的值，**是已處理轉發 (Forwarded) 後的最終值** |
| `CmpOp[2:0]` | 3 | I | 比較操作控制信號（来自 D_Controller） ，例如 `CMP_beq` |
| `D_bjump` | 1 | O | 比較結果 / 分支條件滿足標誌 (1=滿足, 0=不滿足)，此信號將送往 `NPC` 模塊進行下一PC決策 |

**注意：GRF读出的rs/rt值先转发，再连接到CMP和下一级寄存器**

### DF_NPC (Next Program Counter)

功能: 计算下一条指令地址 (PC+4 或分支目标地址)。

| 端口名 | 位宽 | 方向 | 功能说明 |
|---|---|---|---|
| F_PC[31:0] | 32 | I | F级获取的指令地址 |
| D_PC[31:0] | 32 | I | D级获取的流水指令地址，用于跳转PC+8 |
| D_imm26[25:0] | 26 | I | 26位立即数 |
| D_imm16[25:0] | 26 | I | 16位立即数 |
| D_RA[31:0]  | 32 | I | **转发后**$31保存的寄存器地址,**来自A1**|
| nPC_sel[1:0] | 2 | I | 下一 PC 选择信号 |
| `D_bjump` | 1 | I | 分支条件满足标志 (用于 beq 条件判断) |
| NPC[31:0] | 32 | O | 下一条指令地址 |

**注意RA需要先转发（例如汇编中保存寄存器的sp）**

---
## DE_REG（ID/EX 流水线寄存器）
锁存 ID 级（译码）的输出，作为 EX 级（执行）的输入。需传递所有数据和控制信号，并**支持「清空」以处理 `lw` 指令的加载延迟槽**。

| 端口名 | 位宽 | 方向 | 功能说明 |
|--------|------|------|----------|
| clk    | 1    | I    | 时钟信号 |
| reset  | 1    | I    | 同步复位信号 |
| DE_clr | 1    | I    | 寄存器清除（1=清零/插入nop，0=正常） |
| **（数据输入）** |      |      |          |
| D_V1   | 32   | I    | 来自 ID 级的 已转发过的RF 读出值 1（V1） |
| D_V2   | 32   | I    | 来自 ID 级的 已转发过的RF 读出值 2（V2） |
| D_E32  | 32   | I    | 来自 ID 级的 32 位立即数扩展结果 |
| **（地址输入）** |      |      |          |
| D_PC   | 32   | I    | 来自 ID 级的 PC 值 |
| D_A3   | 5   | I     | 来自 ID 级产生的写入寄存器地址 | 
| **（指令输入）包含rt,rd,rs地址）** |      |      |          |
| D_Instr | 32 | I | 来自FD_REG上一级的指令 |
| **（控制输入）** |      |      |          |
| **（数据输出）** |      |      |          |
| E_V1   | 32   | O    | 输出到 EX 级的 V1 |
| E_V2   | 32   | O    | 输出到 EX 级的 V2 |
| E_E32  | 32   | O    | 输出到 EX 级的 E32  |
| **（地址输入）** |      |      |          |
| E_PC   | 32   | O    | 输出到 EX 级的 当前指令地址 |
| E_A3   | 5   | O     | 输出到 EX 级的 写入寄存器地址 | 
| **（指令输出）** |      |      |          |
| E_Instr | 32   |   O   | 输出到EX一级的指令 |
| **（控制输出）** |      |      |          |
| E_Tnew   | 2    | O    | **生成** EX 级的 T_new 值 |

1. **注意暂停操作需要把这里清空**
2. **E_T_new在这里根据指令产生值。**
---

## E级：EX (执行) 阶段

本阶段主要负责算术逻辑运算。

### ALU (算术逻辑单元)
- **功能**: 执行运算。输入端需要**转发MUX**来接收来自 EX, MEM, WB 级的数据。

| 端口名 | 位宽 | 方向 | 功能说明 |
| :--- | :--- | :--- | :--- |
| A | 32 | I |   输入操作数 1 (来自**转发 MUX A**) |
| B | 32 | I |   输入操作数 2 (来自**转发 MUX B**) |
| E_ALUOp | 3 | I | 运算控制信号 (来自**E_Controller**) |
| E_AO | 32 | O | 运算结果 (ALU Out)|

### ALU_B_MUX   
- **功能**：选择ALU B输入端的数据: 转发过的V2 或者 E32。
  
| 端口名 | 位宽 | 方向 | 功能说明 |
| :--- | :--- | :--- | :--- |
| E_V2 | 32 | I | E级的第二个值V2(RD2)|
| E_ALU_BSrc | 2 | I | 选择信号| 
| E_ALUB | 32 | O | 输出到ALUB端的数值  |


### E_WD_MUX   
- **功能**：E级处，选择正确的寄存器写入值，即为转发出的值
这时，能产生正确写入值的指令只有PC类(jal)【**策略矩阵**】

| 端口名 | 位宽 | 方向 | 功能说明 |
| :--- | :--- | :--- | :--- |
| E_PC | 32 | I | 输入E级的指令当前地址|
| E_Reg_WrSrc| 2 | I | 选择信号（只有jal类信号有值，其他均为0 | 
| E_WD | 32 | O | E级处产生的写入值（只可能是PC+8，其他均为0） (**一直往后送**)  |

---
## EM_REG（EX/MEM 流水线寄存器）

| 端口名 | 位宽 | 方向 | 功能说明 |
|--------|------|------|----------|
| clk    | 1    | I    | 时钟信号 |
| reset  | 1    | I    | 同步复位信号 |
| **（指令输入）** |      |      |          |
| E_Instr | 32   |   O   | 来自EX一级的指令 |
| **（数据输入）** |      |      |          |
| E_AO    | 32   | I    | 来自 EX 级的 ALU 运算结果  |
| E_V2    | 32   | I    | 来自 EX 级的 V2 值（用于 sw 写入 DM） |
| E_PC    | 32   | I    | 来自 EX 级的 当前指令地址 |
| **（地址输入）** |      |      |          |
| E_A3    | 5    | I    | 来自 EX 级的 A3（目的寄存器）地址  |
| **（控制输入）** |      |      |          |
| E_Tnew    | 2    | I    | 来自 EX 级的 T_new 值 |
| **（指令输出）** |      |      |          |
| M_Instr | 32   |   O   | 输出到 MWM 级的指令 |
| **（数据输出）** |      |      |          |
| M_AO    | 32   | O    | 输出到 MEM 级的 ALU 结果 |
| M_V2    | 32   | O    | 输出到 MEM 级的 V2 值 |
| M_PC    | 32   | O    | 输出到 MEM 级的 当前指令地址（用于 jal 回写）  |
| **（地址输出）** |      |      |          |
| M_A3    | 5    | O    | 输出到 MEM 级的 A3 地址 |
| M_Tnew    | 2    | O    | 输出到 MEM 级的 T_new 值 **需要减一** |

1. **记得Tnew -1**
   
---

## M级：MEM (访存) 阶段

本阶段负责与数据存储器交互。


### M_WD_MUX   
- **功能**：M级处，选择正确的寄存器写入值，即为可能转发出的值
这时，能产生正确写入值的指令有PC类(jal)和ALU类【**策略矩阵**】

| 端口名 | 位宽 | 方向 | 功能说明 |
| :--- | :--- | :--- | :--- |
| M_PC | 32 | I | 输入E级的指令当前地址|
| M_AO | 32 | I | 上一级计算的ALU结果 |    
| E_Reg_WrSrc| 2 | I | 选择信号 | 
| E_WD | 32 | O | E级处产生的写入值（**只可能是PC+8或ALU结果，其他为0**）  |

---
## MW_REG（MEM/WB 流水线寄存器）

流水线最后一级锁存。

| 端口名 | 位宽 | 方向 | 功能说明 |
|--------|------|------|----------|
| clk    | 1    | I    | 时钟信号 |
| reset  | 1    | I    | 同步复位信号 |
| **（指令输入）** |      |      |          |
| M_Instr | 32   |   O   | 来自 MEM 级的指令 |
| **（数据输入）** |      |      |          |
| M_AO    | 32   | I    | 来自 MEM 级的 ALU 结果 |
| M_RD    | 32   | I    | 来自 MEM 级的 DM 读出数据  |
| M_PC    | 32   | I    | 来自 MEM 级的 PC 值 |
| **（地址输入）** |      |      |          |
| M_A3    | 5    | I    | 来自 MEM 级的 A3（目的寄存器）地址 |
| **（指令输出）** |      |      |          |
| W_Instr | 32   |   O   | 输出到 WB 级的指令 |
| **（数据输出）** |      |      |          |
| W_AO    | 32   | O    | 输出到 WB 级的 ALU 结果  |
| W_RD    | 32   | O    | 输出到 WB 级的 DM 读出数据  |
| W_PC    | 32   | O    | 输出到 WB 级的 PC 值|
| **（地址输出）** |      |      |          |
| W_A3    | 5    | O    | 输出到 WB 级的 A3 地址 |


1. **Tnew一定减为0了**
---
## W级：WB (回写) 阶段

本阶段负责将最终结果写回寄存器堆(GRF)。

### WB_MUX (回写 MUX)
-   **功能**: 选择写回 GRF 的数据来源：是来自 ALU 的结果 (`M_AO`) 还是来自 DM 的结果 (`M_RD`)  还是 PC+8 (`M_PC`)(jal)

| 端口名 | 位宽 | 方向 | 功能说明 |
| :--- | :--- | :--- | :--- |
| AO_W | 32 | I | 来自 `MEM/WB` 的 ALU 结果 |
| DR_W | 32 | I | 来自 `MEM/WB` 的内存读出数据 |
| M_PC | 32 | I | 当前指令值 | 
| Reg_WrSel | 2 | I | 写回数据源选择信号 (来自 `MEM/WB`) |
| W_WD | 32 | O |   最终写回 RF 的数据  |

---

## 流水线专用部件

这些是实现流水线所**必须新增**的模块。

### 数据冲突表

### 表格1：$T_{\text{use}}$ 表
|      | $T_{\text{use}}$ |         |
| :--- | :--------------- | :------ |
|      | rs               | rt      |
| add  | 1                | 1       |
| sub  | 1                | 1       |
| andi | 1                |         |
| ori  | 1                |         |
| lw   | 1                |         |
| sw   | 1                | 2       |
| beq  | 0                | 0       |
| jr   | 0                |         |
|      |                  |         |
|      | {0,1}            | {0,1,2} |


### 表格2：指令、功能部件与 $T_{\text{new}}$ 表
| 指令 | 功能部件 | $T_{\text{new}}$ |      |      |
| :--- | :------- | :--------------- | :--- | :--- |
|      |          | E                | M    | W    |
| add  | ALU      | 1                | 0    | 0    |
| sub  | ALU      | 1                | 0    | 0    |
| andi | ALU      | 1                | 0    | 0    |
| ori  | ALU      | 1                | 0    | 0    |
| lw   | DM       | 2                | 1    | 0    |
| lui  | ALU      | 1                | 0    | 0    |
| sw   |          |                  |      |      |
| beq  |          |                  |      |      |
| jal  | PC       | 0                | 0    | 0    |


### 表格3：策略矩阵
#### rs策略矩阵
| $T_{\text{use}} \ \backslash \ T_{\text{new}}$ | E（ALU） | E（DM） | E（PC） | M（ALU） | M（DM） | M（PC） | W（ALU） | W（DM） | W（PC） |
| :--------------------------------------------- | :------- | :------ | :------ | :------- | :------ | :------ | :------- | :------ | :------ |
| 0                                              | S        | S       | F       | F        | S       | F       | F        | F       | F       |
| 1                                              | F        | S       | F       | F        | F       | F       | F        | F       | F       |


#### rt策略矩阵
| $T_{\text{use}} \ \backslash \ T_{\text{new}}$ | E（ALU） | E（DM） | E（PC） | M（ALU） | M（DM） | M（PC） | W（ALU） | W（DM） | W（PC） |
| :--------------------------------------------- | :------- | :------ | :------ | :------- | :------ | :------ | :------- | :------ | :------ |
| 0                                              | S        | S       | F       | F        | S       | F       | F        | F       | F       |
| 1                                              | F        | S       | F       | F        | F       | F       | F        | F       | F       |
| 2                                              | F        | F       | F       | F        | F       | F       | F        | F       | F       |

### HazardCtrl (数据冲突控制器)
-   **功能**: 核心模块。根据**生产-消费模型**   和**策略矩阵** 生成暂停和转发信号。

| 端口名 | 位宽 | 方向 | 功能说明 |
| :--- | :--- | :--- | :--- |
| D_T_use_RS, D_T_use_RT | 2 | I |   D级指令的 "消费时间" |
| E_Tnew, M_Tnew | 2 | I |   E级和M级指令的 "生产时间" |
| D_A1, D_A2 | 5 | I | D级读取的寄存器地址 |
| E_A3, M_A3| 5 | I |   E, M级的目的寄存器地址  |
| E_RFWr, M_RFWr| 1 | I |   E, M级的写使能信号 |
| Stall | 1 | O |   暂停信号 (送往 PC 和 IF/ID 寄存器)  |
| Fwd_D_RS_Sel | 2 | O |   D级rs通路的比较/转发选择（0=原值，1=来自E，2=来自M） |
| Fwd_D_RT_Sel | 2 | O |   D级rt通路的比较/转发选择信号 |
| E_Fwd_A_Sel | 2 | O |   ALU A端转发MUX控制信号 |
| E_Fwd_B_Sel | 2 | O |   ALU B端转发MUX控制信号 |
| Fwd_M_WD_Sel | 2 | O |   DM写数据端口的前递MUX控制（0=E_V2，1=E结果，2=WB） |

<img src="./assets/image-20251125150822618.png" alt="image-20251125150822618" style="zoom:50%;" />

### Forwarding_MUXes (转发 MUX)

-   **功能**: 位于 EX 级 ALU 的输入端，根据冒险控制器的信号，选择正确的数据来源。
-   D级的RF后 rs、rt各需要一个转发：Fwd_D_RS、Fwd_D_RT
-   E级的ALU A B端各需要一个转发: Fwd_E_ALUA、Fwd_E_ALUB
-   M级 DM处的WD输入需要一个转发: Fwd_M_WD
转发信息来源：

- E_WD: EX/MEM级是jal类指令，在该级产生正确结果，需要传递PC+8（其他的指令Tnew != 0）
- M_WD: MEM/WB是jal、计算类指令，在该级产生正确结果，需要传递PC+8/ALU结果
- W_WD: 所有指令在该级已经产生正确结果，需要传递ALU结果。

以Fwd_E_ALUB为例
| 端口名 | 位宽 | 方向 | 功能说明 |
| :--- | :--- | :--- | :--- |
| E_V2 | 32 | I |   来源0：ID/EX 寄存器的 V2 值 (默认)  |
| M_WD | 32 | I |   来源2：MEM/WB 的写入数据 |
| W_WD | 32 | I |   来源3：WB 的写入数据 |
| Fwd_B_Sel | 2 | I | 选择信号 (来自 Hazard Controller) |
| ALU_B | 32 | O |   最终送往 ALU B端的数据 [cite: 457] |

